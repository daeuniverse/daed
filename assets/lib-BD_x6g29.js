function e(e){return e===null?`null`:Array.isArray(e)?`array`:typeof e}function t(t){return e(t)===`object`}function n(e){return Array.isArray(e)&&e.length>0&&e.every(e=>`message`in e)}function r(e,t){return e.length<124?e:t}var i;(function(e){e[e.InternalServerError=4500]=`InternalServerError`,e[e.InternalClientError=4005]=`InternalClientError`,e[e.BadRequest=4400]=`BadRequest`,e[e.BadResponse=4004]=`BadResponse`,e[e.Unauthorized=4401]=`Unauthorized`,e[e.Forbidden=4403]=`Forbidden`,e[e.SubprotocolNotAcceptable=4406]=`SubprotocolNotAcceptable`,e[e.ConnectionInitialisationTimeout=4408]=`ConnectionInitialisationTimeout`,e[e.ConnectionAcknowledgementTimeout=4504]=`ConnectionAcknowledgementTimeout`,e[e.SubscriberAlreadyExists=4409]=`SubscriberAlreadyExists`,e[e.TooManyInitialisationRequests=4429]=`TooManyInitialisationRequests`})(i||={});var a;(function(e){e.ConnectionInit=`connection_init`,e.ConnectionAck=`connection_ack`,e.Ping=`ping`,e.Pong=`pong`,e.Subscribe=`subscribe`,e.Next=`next`,e.Error=`error`,e.Complete=`complete`})(a||={});function o(r){if(!t(r))throw Error(`Message is expected to be an object, but got ${e(r)}`);if(!r.type)throw Error(`Message is missing the 'type' property`);if(typeof r.type!=`string`)throw Error(`Message is expects the 'type' property to be a string, but got ${e(r.type)}`);switch(r.type){case a.ConnectionInit:case a.ConnectionAck:case a.Ping:case a.Pong:if(r.payload!=null&&!t(r.payload))throw Error(`"${r.type}" message expects the 'payload' property to be an object or nullish or missing, but got "${r.payload}"`);break;case a.Subscribe:if(typeof r.id!=`string`)throw Error(`"${r.type}" message expects the 'id' property to be a string, but got ${e(r.id)}`);if(!r.id)throw Error(`"${r.type}" message requires a non-empty 'id' property`);if(!t(r.payload))throw Error(`"${r.type}" message expects the 'payload' property to be an object, but got ${e(r.payload)}`);if(typeof r.payload.query!=`string`)throw Error(`"${r.type}" message payload expects the 'query' property to be a string, but got ${e(r.payload.query)}`);if(r.payload.variables!=null&&!t(r.payload.variables))throw Error(`"${r.type}" message payload expects the 'variables' property to be a an object or nullish or missing, but got ${e(r.payload.variables)}`);if(r.payload.operationName!=null&&e(r.payload.operationName)!==`string`)throw Error(`"${r.type}" message payload expects the 'operationName' property to be a string or nullish or missing, but got ${e(r.payload.operationName)}`);if(r.payload.extensions!=null&&!t(r.payload.extensions))throw Error(`"${r.type}" message payload expects the 'extensions' property to be a an object or nullish or missing, but got ${e(r.payload.extensions)}`);break;case a.Next:if(typeof r.id!=`string`)throw Error(`"${r.type}" message expects the 'id' property to be a string, but got ${e(r.id)}`);if(!r.id)throw Error(`"${r.type}" message requires a non-empty 'id' property`);if(!t(r.payload))throw Error(`"${r.type}" message expects the 'payload' property to be an object, but got ${e(r.payload)}`);break;case a.Error:if(typeof r.id!=`string`)throw Error(`"${r.type}" message expects the 'id' property to be a string, but got ${e(r.id)}`);if(!r.id)throw Error(`"${r.type}" message requires a non-empty 'id' property`);if(!n(r.payload))throw Error(`"${r.type}" message expects the 'payload' property to be an array of GraphQL errors, but got ${JSON.stringify(r.payload)}`);break;case a.Complete:if(typeof r.id!=`string`)throw Error(`"${r.type}" message expects the 'id' property to be a string, but got ${e(r.id)}`);if(!r.id)throw Error(`"${r.type}" message requires a non-empty 'id' property`);break;default:throw Error(`Invalid message 'type' property "${r.type}"`)}return r}function s(e,t){return o(typeof e==`string`?JSON.parse(e,t):e)}function c(e,t){return o(e),JSON.stringify(e,t)}var l=function(e){return this instanceof l?(this.v=e,this):new l(e)},u=function(e,t,n){if(!Symbol.asyncIterator)throw TypeError(`Symbol.asyncIterator is not defined.`);var r=n.apply(e,t||[]),i,a=[];return i={},o(`next`),o(`throw`),o(`return`),i[Symbol.asyncIterator]=function(){return this},i;function o(e){r[e]&&(i[e]=function(t){return new Promise(function(n,r){a.push([e,t,n,r])>1||s(e,t)})})}function s(e,t){try{c(r[e](t))}catch(e){f(a[0][3],e)}}function c(e){e.value instanceof l?Promise.resolve(e.value.v).then(u,d):f(a[0][2],e)}function u(e){s(`next`,e)}function d(e){s(`throw`,e)}function f(e,t){e(t),a.shift(),a.length&&s(a[0][0],a[0][1])}};function d(e){let{url:t,connectionParams:n,lazy:o=!0,onNonLazyError:d=console.error,lazyCloseTimeout:g=0,keepAlive:_=0,disablePong:v,connectionAckWaitTimeout:y=0,retryAttempts:b=5,retryWait:x=async function(e){let t=1e3;for(let n=0;n<e;n++)t*=2;await new Promise(e=>setTimeout(e,t+Math.floor(Math.random()*2700+300)))},shouldRetry:S=p,isFatalConnectionProblem:C,on:w,webSocketImpl:T,generateID:E=function(){return`xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx`.replace(/[xy]/g,e=>{let t=Math.random()*16|0;return(e==`x`?t:t&3|8).toString(16)})},jsonMessageReplacer:D,jsonMessageReviver:O}=e,k;if(T){if(!h(T))throw Error(`Invalid WebSocket implementation provided`);k=T}else typeof WebSocket<`u`?k=WebSocket:typeof global<`u`?k=global.WebSocket||global.MozWebSocket:typeof window<`u`&&(k=window.WebSocket||window.MozWebSocket);if(!k)throw Error("WebSocket implementation missing; on Node you can `import WebSocket from 'ws';` and pass `webSocketImpl: WebSocket` to `createClient`");let A=k,j=(()=>{let e=(()=>{let e={};return{on(t,n){return e[t]=n,()=>{delete e[t]}},emit(t){var n;`id`in t&&((n=e[t.id])==null||n.call(e,t))}}})(),t={connecting:w?.connecting?[w.connecting]:[],opened:w?.opened?[w.opened]:[],connected:w?.connected?[w.connected]:[],ping:w?.ping?[w.ping]:[],pong:w?.pong?[w.pong]:[],message:w?.message?[e.emit,w.message]:[e.emit],closed:w?.closed?[w.closed]:[],error:w?.error?[w.error]:[]};return{onMessage:e.on,on(e,n){let r=t[e];return r.push(n),()=>{r.splice(r.indexOf(n),1)}},emit(e,...n){for(let r of[...t[e]])r(...n)}}})();function M(e){let t=[j.on(`error`,n=>{t.forEach(e=>e()),e(n)}),j.on(`closed`,n=>{t.forEach(e=>e()),e(n)})]}let N,P=0,F,I=!1,L=0,R=!1;async function z(){clearTimeout(F);let[e,o]=await(N??=new Promise((e,o)=>(async()=>{if(I){if(await x(L),!P)return N=void 0,o({code:1e3,reason:`All Subscriptions Gone`});L++}j.emit(`connecting`,I);let l=new A(typeof t==`function`?await t():t,`graphql-transport-ws`),u,d;function p(){isFinite(_)&&_>0&&(clearTimeout(d),d=setTimeout(()=>{l.readyState===A.OPEN&&(l.send(c({type:a.Ping})),j.emit(`ping`,!1,void 0))},_))}M(e=>{N=void 0,clearTimeout(u),clearTimeout(d),o(e),e instanceof f&&(l.close(4499,`Terminated`),l.onerror=null,l.onclose=null)}),l.onerror=e=>j.emit(`error`,e),l.onclose=e=>j.emit(`closed`,e),l.onopen=async()=>{try{j.emit(`opened`,l);let e=typeof n==`function`?await n():n;if(l.readyState!==A.OPEN)return;l.send(c(e?{type:a.ConnectionInit,payload:e}:{type:a.ConnectionInit},D)),isFinite(y)&&y>0&&(u=setTimeout(()=>{l.close(i.ConnectionAcknowledgementTimeout,`Connection acknowledgement timeout`)},y)),p()}catch(e){j.emit(`error`,e),l.close(i.InternalClientError,r(e instanceof Error?e.message:Error(e).message,`Internal client error`))}};let m=!1;l.onmessage=({data:t})=>{try{let n=s(t,O);if(j.emit(`message`,n),n.type===`ping`||n.type===`pong`){j.emit(n.type,!0,n.payload),n.type===`pong`?p():v||(l.send(c(n.payload?{type:a.Pong,payload:n.payload}:{type:a.Pong})),j.emit(`pong`,!1,n.payload));return}if(m)return;if(n.type!==a.ConnectionAck)throw Error(`First message cannot be of type ${n.type}`);clearTimeout(u),m=!0,j.emit(`connected`,l,n.payload,I),I=!1,L=0,e([l,new Promise((e,t)=>M(t))])}catch(e){l.onmessage=null,j.emit(`error`,e),l.close(i.BadResponse,r(e instanceof Error?e.message:Error(e).message,`Bad response`))}}})()));e.readyState===A.CLOSING&&await o;let l=()=>{},u=new Promise(e=>l=e);return[e,l,Promise.race([u.then(()=>{if(!P){let t=()=>e.close(1e3,`Normal Closure`);isFinite(g)&&g>0?F=setTimeout(()=>{e.readyState===A.OPEN&&t()},g):t()}}),o])]}function B(e){if(p(e)&&(m(e.code)||[i.InternalServerError,i.InternalClientError,i.BadRequest,i.BadResponse,i.Unauthorized,i.SubprotocolNotAcceptable,i.SubscriberAlreadyExists,i.TooManyInitialisationRequests].includes(e.code)))throw e;if(R)return!1;if(p(e)&&e.code===1e3)return P>0;if(!b||L>=b||!S(e)||C?.(e))throw e;return I=!0}o||(async()=>{for(P++;;)try{let[,,e]=await z();await e}catch(e){try{if(!B(e))return}catch(e){return d?.(e)}}})();function V(e,t){let n=E(e),r=!1,i=!1,o=()=>{P--,r=!0};return(async()=>{for(P++;;)try{let[s,l,u]=await z();if(r)return l();let d=j.onMessage(n,e=>{switch(e.type){case a.Next:t.next(e.payload);return;case a.Error:i=!0,r=!0,t.error(e.payload),o();return;case a.Complete:r=!0,o();return}});s.send(c({id:n,type:a.Subscribe,payload:e},D)),o=()=>{!r&&s.readyState===A.OPEN&&s.send(c({id:n,type:a.Complete},D)),P--,r=!0,l()},await u.finally(d);return}catch(e){if(!B(e))return}})().then(()=>{i||t.complete()}).catch(e=>{t.error(e)}),()=>{r||o()}}return{on:j.on,subscribe:V,iterate(e){let t=[],n={done:!1,error:null,resolve:()=>{}},r=V(e,{next(e){t.push(e),n.resolve()},error(e){n.done=!0,n.error=e,n.resolve()},complete(){n.done=!0,n.resolve()}}),i=(function(){return u(this,arguments,function*(){for(;;){for(t.length||(yield l(new Promise(e=>n.resolve=e)));t.length;)yield yield l(t.shift());if(n.error)throw n.error;if(n.done)return yield l(void 0)}})})();return i.throw=async e=>(n.done||(n.done=!0,n.error=e,n.resolve()),{done:!0,value:void 0}),i.return=async()=>(r(),{done:!0,value:void 0}),i},async dispose(){if(R=!0,N){let[e]=await N;e.close(1e3,`Normal Closure`)}},terminate(){N&&j.emit(`closed`,new f)}}}var f=class extends Error{constructor(){super(...arguments),this.name=`TerminatedCloseEvent`,this.message=`4499: Terminated`,this.code=4499,this.reason=`Terminated`,this.wasClean=!1}};function p(e){return t(e)&&`code`in e&&`reason`in e}function m(e){return[1e3,1001,1006,1005,1012,1013,1014].includes(e)?!1:e>=1e3&&e<=1999}function h(e){return typeof e==`function`&&`constructor`in e&&`CLOSED`in e&&`CLOSING`in e&&`CONNECTING`in e&&`OPEN`in e}export{d as createClient};