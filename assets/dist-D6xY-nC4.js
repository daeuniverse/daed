function e(e){return e===null?`null`:Array.isArray(e)?`array`:typeof e}function t(t){return e(t)===`object`}function n(e){return Array.isArray(e)&&e.length>0&&e.every(e=>`message`in e)}function r(e,t){return e.length<124?e:t}var i=(e=>(e[e.InternalServerError=4500]=`InternalServerError`,e[e.InternalClientError=4005]=`InternalClientError`,e[e.BadRequest=4400]=`BadRequest`,e[e.BadResponse=4004]=`BadResponse`,e[e.Unauthorized=4401]=`Unauthorized`,e[e.Forbidden=4403]=`Forbidden`,e[e.SubprotocolNotAcceptable=4406]=`SubprotocolNotAcceptable`,e[e.ConnectionInitialisationTimeout=4408]=`ConnectionInitialisationTimeout`,e[e.ConnectionAcknowledgementTimeout=4504]=`ConnectionAcknowledgementTimeout`,e[e.SubscriberAlreadyExists=4409]=`SubscriberAlreadyExists`,e[e.TooManyInitialisationRequests=4429]=`TooManyInitialisationRequests`,e))(i||{}),a=(e=>(e.ConnectionInit=`connection_init`,e.ConnectionAck=`connection_ack`,e.Ping=`ping`,e.Pong=`pong`,e.Subscribe=`subscribe`,e.Next=`next`,e.Error=`error`,e.Complete=`complete`,e))(a||{});function o(r){if(!t(r))throw Error(`Message is expected to be an object, but got ${e(r)}`);if(!r.type)throw Error(`Message is missing the 'type' property`);if(typeof r.type!=`string`)throw Error(`Message is expects the 'type' property to be a string, but got ${e(r.type)}`);switch(r.type){case`connection_init`:case`connection_ack`:case`ping`:case`pong`:if(r.payload!=null&&!t(r.payload))throw Error(`"${r.type}" message expects the 'payload' property to be an object or nullish or missing, but got "${r.payload}"`);break;case`subscribe`:if(typeof r.id!=`string`)throw Error(`"${r.type}" message expects the 'id' property to be a string, but got ${e(r.id)}`);if(!r.id)throw Error(`"${r.type}" message requires a non-empty 'id' property`);if(!t(r.payload))throw Error(`"${r.type}" message expects the 'payload' property to be an object, but got ${e(r.payload)}`);if(typeof r.payload.query!=`string`)throw Error(`"${r.type}" message payload expects the 'query' property to be a string, but got ${e(r.payload.query)}`);if(r.payload.variables!=null&&!t(r.payload.variables))throw Error(`"${r.type}" message payload expects the 'variables' property to be a an object or nullish or missing, but got ${e(r.payload.variables)}`);if(r.payload.operationName!=null&&e(r.payload.operationName)!==`string`)throw Error(`"${r.type}" message payload expects the 'operationName' property to be a string or nullish or missing, but got ${e(r.payload.operationName)}`);if(r.payload.extensions!=null&&!t(r.payload.extensions))throw Error(`"${r.type}" message payload expects the 'extensions' property to be a an object or nullish or missing, but got ${e(r.payload.extensions)}`);break;case`next`:if(typeof r.id!=`string`)throw Error(`"${r.type}" message expects the 'id' property to be a string, but got ${e(r.id)}`);if(!r.id)throw Error(`"${r.type}" message requires a non-empty 'id' property`);if(!t(r.payload))throw Error(`"${r.type}" message expects the 'payload' property to be an object, but got ${e(r.payload)}`);break;case`error`:if(typeof r.id!=`string`)throw Error(`"${r.type}" message expects the 'id' property to be a string, but got ${e(r.id)}`);if(!r.id)throw Error(`"${r.type}" message requires a non-empty 'id' property`);if(!n(r.payload))throw Error(`"${r.type}" message expects the 'payload' property to be an array of GraphQL errors, but got ${JSON.stringify(r.payload)}`);break;case`complete`:if(typeof r.id!=`string`)throw Error(`"${r.type}" message expects the 'id' property to be a string, but got ${e(r.id)}`);if(!r.id)throw Error(`"${r.type}" message requires a non-empty 'id' property`);break;default:throw Error(`Invalid message 'type' property "${r.type}"`)}return r}function s(e,t){return o(typeof e==`string`?JSON.parse(e,t):e)}function c(e,t){return o(e),JSON.stringify(e,t)}function l(e){let{url:t,connectionParams:n,lazy:o=!0,onNonLazyError:l=console.error,lazyCloseTimeout:m=0,keepAlive:h=0,disablePong:g,connectionAckWaitTimeout:_=0,retryAttempts:v=5,retryWait:y=async function(e){let t=2**e;await new Promise(e=>setTimeout(e,t*1e3+Math.floor(Math.random()*2700+300)))},shouldRetry:b=d,on:x,webSocketImpl:S,generateID:C=function(){return`xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx`.replace(/[xy]/g,e=>{let t=Math.random()*16|0;return(e==`x`?t:t&3|8).toString(16)})},jsonMessageReplacer:w,jsonMessageReviver:T}=e,E;if(S){if(!p(S))throw Error(`Invalid WebSocket implementation provided`);E=S}else typeof WebSocket<`u`?E=WebSocket:typeof global<`u`?E=global.WebSocket||global.MozWebSocket:typeof window<`u`&&(E=window.WebSocket||window.MozWebSocket);if(!E)throw Error("WebSocket implementation missing; on Node you can `import WebSocket from 'ws';` and pass `webSocketImpl: WebSocket` to `createClient`");let D=E,O=(()=>{let e=(()=>{let e={};return{on(t,n){return e[t]=n,()=>{delete e[t]}},emit(t){`id`in t&&e[t.id]?.(t)}}})(),t={connecting:x?.connecting?[x.connecting]:[],opened:x?.opened?[x.opened]:[],connected:x?.connected?[x.connected]:[],ping:x?.ping?[x.ping]:[],pong:x?.pong?[x.pong]:[],message:x?.message?[e.emit,x.message]:[e.emit],closed:x?.closed?[x.closed]:[],error:x?.error?[x.error]:[]};return{onMessage:e.on,on(e,n){let r=t[e];return r.push(n),()=>{r.splice(r.indexOf(n),1)}},emit(e,...n){for(let r of[...t[e]])r(...n)}}})();function k(e){let t=[O.on(`error`,n=>{t.forEach(e=>e()),e(n)}),O.on(`closed`,n=>{t.forEach(e=>e()),e(n)})]}let A,j=0,M,N=!1,P=0,F=!1;async function I(){clearTimeout(M);let[e,o]=await(A??=new Promise((e,o)=>(async()=>{if(N){if(await y(P),!j)return A=void 0,o({code:1e3,reason:`All Subscriptions Gone`});P++}O.emit(`connecting`,N);let l=new D(typeof t==`function`?await t():t,`graphql-transport-ws`),d,f;function p(){isFinite(h)&&h>0&&(clearTimeout(f),f=setTimeout(()=>{l.readyState===D.OPEN&&(l.send(c({type:a.Ping})),O.emit(`ping`,!1,void 0))},h))}k(e=>{A=void 0,clearTimeout(d),clearTimeout(f),o(e),e instanceof u&&(l.close(4499,`Terminated`),l.onerror=null,l.onclose=null)}),l.onerror=e=>O.emit(`error`,e),l.onclose=e=>O.emit(`closed`,e),l.onopen=async()=>{try{O.emit(`opened`,l);let e=typeof n==`function`?await n():n;if(l.readyState!==D.OPEN)return;l.send(c(e?{type:a.ConnectionInit,payload:e}:{type:a.ConnectionInit},w)),isFinite(_)&&_>0&&(d=setTimeout(()=>{l.close(i.ConnectionAcknowledgementTimeout,`Connection acknowledgement timeout`)},_)),p()}catch(e){O.emit(`error`,e),l.close(i.InternalClientError,r(e instanceof Error?e.message:String(e),`Internal client error`))}};let m=!1;l.onmessage=({data:t})=>{try{let n=s(t,T);if(O.emit(`message`,n),n.type===`ping`||n.type===`pong`){O.emit(n.type,!0,n.payload),n.type===`pong`?p():g||(l.send(c(n.payload?{type:a.Pong,payload:n.payload}:{type:a.Pong})),O.emit(`pong`,!1,n.payload));return}if(m)return;if(n.type!==a.ConnectionAck)throw Error(`First message cannot be of type ${n.type}`);clearTimeout(d),m=!0,O.emit(`connected`,l,n.payload,N),N=!1,P=0,e([l,new Promise((e,t)=>k(t))])}catch(e){l.onmessage=null,O.emit(`error`,e),l.close(i.BadResponse,r(e instanceof Error?e.message:String(e),`Bad response`))}}})()));e.readyState===D.CLOSING&&await o;let l=()=>{},d=new Promise(e=>l=e);return[e,l,Promise.race([d.then(()=>{if(!j){let t=()=>e.close(1e3,`Normal Closure`);isFinite(m)&&m>0?M=setTimeout(()=>{e.readyState===D.OPEN&&t()},m):t()}}),o])]}function L(e){if(d(e)&&(f(e.code)||[i.InternalServerError,i.InternalClientError,i.BadRequest,i.BadResponse,i.Unauthorized,i.SubprotocolNotAcceptable,i.SubscriberAlreadyExists,i.TooManyInitialisationRequests].includes(e.code)))throw e;if(F)return!1;if(d(e)&&e.code===1e3)return j>0;if(!v||P>=v||!b(e))throw e;return N=!0}o||(async()=>{for(j++;;)try{let[,,e]=await I();await e}catch(e){try{if(!L(e))return}catch(e){return l?.(e)}}})();function R(e,t){let n=C(e),r=!1,i=!1,o=()=>{j--,r=!0};return(async()=>{for(j++;;)try{let[s,l,u]=await I();if(r)return l();let d=O.onMessage(n,e=>{switch(e.type){case a.Next:t.next(e.payload);return;case a.Error:i=!0,r=!0,t.error(e.payload),o();return;case a.Complete:r=!0,o();return}});s.send(c({id:n,type:a.Subscribe,payload:e},w)),o=()=>{!r&&s.readyState===D.OPEN&&s.send(c({id:n,type:a.Complete},w)),j--,r=!0,l()},await u.finally(d);return}catch(e){if(!L(e))return}})().then(()=>{i||t.complete()}).catch(e=>{t.error(e)}),()=>{r||o()}}return{on:O.on,subscribe:R,iterate(e){let t=[],n={done:!1,error:null,resolve:()=>{}},r=R(e,{next(e){t.push(e),n.resolve()},error(e){n.done=!0,n.error=e,n.resolve()},complete(){n.done=!0,n.resolve()}}),i=async function*(){for(;;){for(t.length||await new Promise(e=>n.resolve=e);t.length;)yield t.shift();if(n.error)throw n.error;if(n.done)return}}();return i.throw=async e=>(n.done||(n.done=!0,n.error=e,n.resolve()),{done:!0,value:void 0}),i.return=async()=>(r(),{done:!0,value:void 0}),i},async dispose(){if(F=!0,A){let[e]=await A;e.close(1e3,`Normal Closure`)}},terminate(){A&&O.emit(`closed`,new u)}}}var u=class extends Error{name=`TerminatedCloseEvent`;message=`4499: Terminated`;code=4499;reason=`Terminated`;wasClean=!1};function d(e){return t(e)&&`code`in e&&`reason`in e}function f(e){return[1e3,1001,1006,1005,1012,1013,1014].includes(e)?!1:e>=1e3&&e<=1999}function p(e){return typeof e==`function`&&`constructor`in e&&`CLOSED`in e&&`CLOSING`in e&&`CONNECTING`in e&&`OPEN`in e}export{l as createClient};